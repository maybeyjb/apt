# 流量隐匿

蓝队的设备会分析到流量特征然后拉黑ip；c2：MSF  CS Sliver Chaos  Viper 等   webshell ：菜刀 蚁剑 哥斯拉  冰鞋

  nc  明文传输 容易被发现，所以就需要在我们攻击端生成自己的证书，让通讯流量加密，好比http 和 https 区别。

![image-20241228173939844](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525406.png)

打开wireshark进行抓包，获取到的流量追踪流得到刚才执行命令，发现这里都是明文：

![image-20241228174311812](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525407.png)

 生成证书工具openssl，流量通讯就会加密，就不会让蓝队容易发现：

![image-20241228175242330](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525408.png)

这下流量就经过加密了，没有解密就无法判断执行看什么：

![image-20241228175124249](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525409.png)



##### MSF

###### http:

  MSf 生成HTTP(reverse_http)后门执行上线，在目标机上捕获流量数据包，走的是http协议：

MSF http  ： 第一次数据包，有post和get    post可能就是上线后我们执行命令产生的数据包。

MSF  http ：第二次数据包（和第一次上线时候的后门是一样的），也是有post和get数据包，两次对比流量数据包

发现两次的  get 数据包都是5行数据，有两个固定的connection 和 cache-control两个头，这是msf的弱特征，正常的网站数据包一般不会固定行数和有两个固定头。

MSF上线火绒机就不演示了，（免杀先不考虑），下面是执行上线命令后在目标机上捕获到的数据包：

![image-20241228180427093](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525410.png)

get数据和post数据包：

![image-20241228180712498](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525411.png)

第二次上线的数据包，将监听端口换成1234：

![image-20241228181805581](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525412.png)

不难看出 Get包是Connection: Keep-Alive        Cache-Control：no-cache这两个头不变

###### https

MSF HTTPS(reverse_https)，继续执行上线，在捕获流量数据包，这里走的就是tls协议：

 数据包中会有https证书的信息,这里证书会变（每次监听都会变），没有特征。

![image-20241228184536323](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525413.png)

这里访问msf的后门地址，查看证书和流量包中的证书一样（当然每次不同后门，证书也是不同，随机变化的）。所以没有特征。工具中自带的随机方式更改证书：

![image-20241228200218482](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525414.png)

  利用工具生成一个带有baidu的证书，这样就会信任，在用这个证书生成一个后门，捕获到的流量/打开后门的网址的证书就是Baidu的证书。也不是说信任，就是可以迷惑蓝队在分析流量包，他如果不懂看见baidu的证书可能就放过这个流量包了：

生成证书，在生成一个带证书的后门：

![image-20241228203552747](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525415.png)

监听：

![image-20241228203631973](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525416.png)

最后的证书就是www.baidu.com

##### CS：

###### http：

 cs强特征：get请求为5行数据，post 请求为submit.php?id=数字    post 的UA头，get路径特征：checksum8算法，get /....     算法解密字符为93-----上线的目标机为64位           92 ------ 32位       免杀前面讲过

用cs的http后门上线，捕捉到的流量，几个特征还是比较明显的  GET还是5行， 完了post有submit.php  还有UA也像，当然get后面那个 /Yi7d 是根据checksum算法生成的：

![image-20241228204618439](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525417.png)



改特征的思路：1、二开魔改  2、引用profiles文件，更改请求规则实现更改特征

  用profiles文件，

![image-20241228205942072](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525418.png)

生成新后门后抓取流量，弱特征，checksum8算法更不一样：

![image-20241228210331626](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525419.png)

   改profiles文件，profiles也会改心跳包的延迟时间，改速率。

发现是在这里定的get post方法： 

![image-20241228212346301](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525420.png)

更改特征包：

![image-20241228212558515](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525421.png)

重新启动cs，产生后门上线，抓取流量包：

![image-20241228213031039](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525422.png)

###### https:

tls协议

 只能通过魔改。

创建https的监听器，在生成后门：

![image-20241228213549633](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525423.png)

弱特征，也会有hello：

![image-20241228213931720](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525424.png)

主要特征：JA3/JA3S算法。弱特征：client /server   Hello两个特征，cs第一次通讯会产生的。

强特征：ja3box工具、解数据包的信息。将数据包导出来用工具解密，（也支持监听网卡的流量）然后对比解密出来的md5值和cs的ja3的特征md5值进行比对。  就是比对TLS协议包（https），https主要就是这个ja3/ja3s特征。

那么下来想改动这个ja3特征，就只能通过魔改源码进行更改ja3特征。

![image-20241228214452853](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525425.png)

下来就是将刚才cs抓到的流量包保存到ja3box.py目录下：

![image-20241228214607945](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525426.png)

将刚才保存的流量https.pcapng解开，对比后和cs特征值一样，那就可以判断为cs，这是https的强特征：

![image-20241228215427539](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525427.png)

![image-20241228215321594](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525428.png)

那么怎么改这种强特征呢，就只能在源码中改。可以在公众号或者在一些星球中看怎么魔改，xd这里没有演示，我猜他也不会。。。（xd说他后面蓝队讲，我猜是缓兵之计。。。）

###### else:

 更cs默认端口，改启动文件，teamserver就行。还有更改证书指纹，自己重新添加一个证书，然后更改cs启动调用的证书文件位自己更改后的。----这两个特征是基础特征，就是第一个需要改的。

cs默认端口一般为50000/50050，这里也需要改：

![image-20241228220541809](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525429.png)

还需要改证书，上面可以看见，启动时候会加载cs的.store证书，查看cs证书：

![image-20241228220907089](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525430.png)

所以这样改就行，画红线的都是可以自己操作，改成自己想的：

![image-20241228221150557](https://cdn.jsdelivr.net/gh/maybeyjb/blue-team/img/202506161525431.png)
